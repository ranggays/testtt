<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rekapitulasi</title>
  <link rel="stylesheet" href="rekapitulasi.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Basic styling - add your rekapitulasi.css styles here */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    
    .header-wrapper {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo img {
      width: 40px;
      height: 40px;
    }
    
    .nav-links {
      display: flex;
      gap: 2rem;
    }
    
    .nav-links a {
      text-decoration: none;
      color: #333;
      padding: 0.5rem 1rem;
      border-radius: 4px;
    }
    
    .nav-links a.active {
      background-color: #007bff;
      color: white;
    }
    
    .main-content {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    
    .header h2 {
      margin: 0;
      color: #333;
    }
    
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background-color: #0056b3;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    table th,
    table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      color: #333;
    }
    
    table th {
      background-color: #007bff;
      color: white;
      font-weight: 600;
    }
    
    table tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    table tr:hover {
      background-color: #e9ecef;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
    }
    
    .close {
      position: absolute;
      right: 1rem;
      top: 1rem;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .modal-content label {
      display: block;
      margin: 1rem 0 0.5rem 0;
      font-weight: 600;
    }
    
    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .modal-content button {
      width: 100%;
      margin-top: 1rem;
    }
    
    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge.ringan {
      background-color: #d4edda;
      color: #155724;
    }
    
    .badge.sedang {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .badge.berat {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .badge.sangat-berat {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    
    #emptyState {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    
    .debug-info {
      background-color: #e3f2fd;
      border: 1px solid #2196f3;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>

  
<div class="header-wrapper">
    <header class="navbar">
      <div class="logo">
        <img src="image.png" alt="Logo" />
        <span>SMAN 1 KARANGAN</span>
      </div>
      <nav class="nav-links">
        <a href="home.html" >Home</a>
        <a href="list-pelanggaran.html">List Pelanggaran</a>
        <a href="rekapitulasi.html" class="active">Rekap Pelanggaran</a>
        <a href="info.html">Info ▾</a>
        <a href="contact.html">Contact</a>
      </nav>
    </header>
  </div>
        
  <div class="main-content">
    <div class="header">
      <h2>REKAPITULASI PELANGGARAN TATA TERTIB SISWA</h2>
      <button id="btnOpenModal">+ Add Data</button>
    </div>

    <!-- Debug Information -->
    <div id="debugInfo" class="debug-info" style="display: none;">
      <h4>Debug Information:</h4>
      <p id="debugText"></p>
    </div>

  <div id="rekapArea">
    <table>
      <thead>
        <tr>
          <th>No</th>
          <th>Nama</th>
          <th>Kelas</th>
          <th>Tanggal</th>
          <th>Pelanggaran</th>
          <th>Skor</th>
          <th>Kategori</th>
          <th>Tindakan</th>
        </tr>
      </thead>
      <tbody id="tabelHasil"></tbody>
    </table>

    </div>

    <button id="downloadPDF" style="margin-top: 16px;">Download PDF</button>

    <div id="loadingState" class="loading" style="display: none;">
      <p>Loading data siswa...</p>
    </div>

    <div id="errorState" class="error" style="display: none;">
      <p id="errorMessage"></p>
    </div>

    <div id="emptyState">
      <img src="https://cdn-icons-png.flaticon.com/512/4076/4076508.png" width="150" alt="Empty illustration">
      <p>Belum ada data pelanggaran.<br>Silakan klik tombol <b>+ Add Data</b> untuk menambahkan.</p>
    </div>
  </div>

  <div id="modalForm" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>

    <!-- LOGIN ADMIN -->
    <div id="loginSection">
      <label for="username">Username Admin:</label>
      <input type="text" id="username" placeholder="Masukkan username">

      <label for="password">Password:</label>
      <input type="password" id="password" placeholder="Masukkan password">

      <button id="loginBtn">Login</button>
    </div>

    <!-- FORM TAMBAH PELANGGARAN -->
    <div id="formSection" style="display:none;">
    <!-- Jenjang (X, XI, XII) -->
    <label for="jenjang">Jenjang:</label>
    <select id="jenjang" onchange="updateKelas()">
      <option value="">-- Pilih Jenjang --</option>
      <option value="X">X</option>
      <option value="XI">XI</option>
      <option value="XII">XII</option>
    </select>
      
    <!-- Kelas (A–I) -->
    <label for="kelasSiswa">Kelas:</label>
    <select id="kelasSiswa" onchange="updateNamaSiswa()" disabled>
      <option value="">-- Pilih Kelas --</option>
    </select>

    <!-- Nama Siswa (Dropdown) -->
    <label for="namaSiswa">Nama Siswa:</label>
    <select id="namaSiswa" required>
      <option value="">-- Pilih Nama --</option>
    </select>

    <!-- Tanggal -->
    <label for="tanggal">Tanggal:</label>
    <input type="date" id="tanggal">

      <label for="kategoriSelect">Kategori Pelanggaran:</label>
      <select id="kategoriSelect">
        <option value="">-- Pilih Kategori --</option>
        <option value="sikap">Sikap Perilaku</option>
        <option value="kedisiplinan">Kedisiplinan</option>
        <option value="kerapian">Kerapian</option>
      </select>

      <label for="pelanggaranSelect">Jenis Pelanggaran:</label>
      <select id="pelanggaranSelect">
        <option value="">-- Pilih Pelanggaran --</option>
      </select>

      <button id="btnTambah">Tambah Pelanggaran</button>
    </div>
  </div>
</div>

  <script>
    // SheetDB Configuration - GANTI DENGAN URL SHEETDB ANDA
    const SHEETDB_URL = 'https://sheetdb.io/api/v1/latgs76bdloli';
    
    // Global variables
    let siswaPerKelas = {};
    let isDataLoaded = false;

    // Debug function
    function showDebug(message) {
      console.log(message);
      const debugDiv = document.getElementById('debugInfo');
      const debugText = document.getElementById('debugText');
      
      if (debugDiv && debugText) {
        debugDiv.style.display = 'block';
        debugText.innerHTML = message;
      }
    }

    // Fungsi untuk debug semua keys di object pertama
    function debugObjectKeys(data) {
      if (data && data.length > 0) {
        const firstRow = data[0];
        const allKeys = Object.keys(firstRow);
        console.log('All available keys in first row:', allKeys);
        showDebug(`Available keys: ${allKeys.join(', ')}<br>Sample values:<br>${allKeys.slice(0, 5).map(key => `${key}: "${firstRow[key]}"`).join('<br>')}`);
        return allKeys;
      }
      return [];
    }

    // Load student data from SheetDB
    async function loadStudentData() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('errorState').style.display = 'none';
      
      try {
        showDebug(`Mencoba mengakses SheetDB: ${SHEETDB_URL}`);
        
        const response = await fetch(SHEETDB_URL);
        showDebug(`Response status: ${response.status}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        showDebug(`Data berhasil dimuat. Jumlah baris: ${data.length}<br>Sample data: ${JSON.stringify(data[0] || {}, null, 2)}`);
        
        // Debug semua keys yang tersedia
        const availableKeys = debugObjectKeys(data);
        
        // Initialize structure
        siswaPerKelas = {
          X: {},
          XI: {},
          XII: {}
        };
        
        // Process the data - coba berbagai kemungkinan nama kolom
        data.forEach((row, index) => {
          // Coba berbagai variasi nama kolom TERMASUK YANG ADA SPASI
          const jenjang = row.Jenjang || row.jenjang || row.JENJANG || 
                         row['Jenjang'] || row['jenjang'] || row['JENJANG'] ||
                         row['Jenjang '] || row['jenjang '] || row['JENJANG '] ||  // DENGAN SPASI
                         row['Jenjang  '] || row['jenjang  '] || row['JENJANG  '];  // DENGAN SPASI GANDA
          
          const kelas = row.Kelas || row.kelas || row.KELAS || 
                       row['Kelas'] || row['kelas'] || row['KELAS'] ||
                       row['Kelas '] || row['kelas '] || row['KELAS '] ||  // DENGAN SPASI
                       row['Kelas  '] || row['kelas  '] || row['KELAS  '];  // DENGAN SPASI GANDA
          
          const nama = row['Nama Siswa'] || row['nama_siswa'] || row.nama || row.Nama || 
                      row['NAMA SISWA'] || row['NAMA_SISWA'] || row.NAMA ||
                      row['Nama'] || row['nama'] || row['NAMA'] ||
                      row['Nama Siswa '] || row['NAMA SISWA '] ||  // DENGAN SPASI
                      row['Nama Siswa  '] || row['NAMA SISWA  '];  // DENGAN SPASI GANDA
          
          if (index < 5) {
            showDebug(`Row ${index}: jenjang="${jenjang}", kelas="${kelas}", nama="${nama}"`);
          }
          
          if (jenjang && kelas && nama) {
            // Bersihkan spasi dan pastikan jenjang valid
            const cleanJenjang = jenjang.toString().trim();
            const cleanKelas = kelas.toString().trim();
            const cleanNama = nama.toString().trim();
            
            const validJenjang = ['X', 'XI', 'XII'].includes(cleanJenjang) ? cleanJenjang : null;
            
            if (validJenjang && cleanKelas && cleanNama) {
              if (!siswaPerKelas[validJenjang][cleanKelas]) {
                siswaPerKelas[validJenjang][cleanKelas] = [];
              }
              
              siswaPerKelas[validJenjang][cleanKelas].push(cleanNama);
              
              // Debug untuk beberapa data pertama
              if (index < 10) {
                console.log(`Added: ${validJenjang} ${cleanKelas} - ${cleanNama}`);
              }
            }
          }
        });
        
        // Sort names alphabetically within each class
        Object.keys(siswaPerKelas).forEach(jenjang => {
          Object.keys(siswaPerKelas[jenjang]).forEach(kelas => {
            siswaPerKelas[jenjang][kelas].sort();
          });
        });
        
        // Debug: tampilkan struktur data yang berhasil dimuat
        let debugOutput = "Data siswa berhasil dimuat:<br>";
        Object.keys(siswaPerKelas).forEach(jenjang => {
          const kelasCount = Object.keys(siswaPerKelas[jenjang]).length;
          const totalSiswa = Object.values(siswaPerKelas[jenjang]).reduce((sum, arr) => sum + arr.length, 0);
          debugOutput += `${jenjang}: ${kelasCount} kelas, ${totalSiswa} siswa<br>`;
          
          // Tampilkan beberapa kelas sebagai contoh
          Object.keys(siswaPerKelas[jenjang]).slice(0, 3).forEach(kelas => {
            const siswaDiKelas = siswaPerKelas[jenjang][kelas].length;
            debugOutput += `&nbsp;&nbsp;${jenjang} ${kelas}: ${siswaDiKelas} siswa<br>`;
          });
        });
        
        showDebug(debugOutput);
        
        isDataLoaded = true;
        document.getElementById('loadingState').style.display = 'none';
        
      } catch (error) {
        console.error('Error loading student data:', error);
        showDebug(`Error: ${error.message}`);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = 
          `Gagal memuat data siswa: ${error.message}. Periksa URL SheetDB dan pastikan data dapat diakses.`;
        
        // Fallback to empty structure but with some test data for debugging
        siswaPerKelas = {
          X: { 
            A: ['Test Siswa 1', 'Test Siswa 2'], 
            B: ['Test Siswa 3', 'Test Siswa 4'], 
            C: [], D: [], E: [], F: [], G: [], H: [], I: [] 
          },
          XI: { 
            A: ['Test Siswa 5', 'Test Siswa 6'], 
            B: [], C: [], D: [], E: [], F: [], G: [], H: [], I: [] 
          },
          XII: { 
            A: ['Test Siswa 7', 'Test Siswa 8'], 
            B: [], C: [], D: [], E: [], F: [], G: [], H: [], I: [] 
          }
        };
        
        showDebug("Menggunakan data test untuk debugging.");
        isDataLoaded = true;
      }
    }

    function updateKelas() {
      const jenjang = document.getElementById("jenjang").value;
      const kelasSelect = document.getElementById("kelasSiswa");
      const namaSelect = document.getElementById("namaSiswa");

      // Reset
      kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
      namaSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';
      kelasSelect.disabled = true;

      console.log(`updateKelas called with jenjang: ${jenjang}`);
      console.log('siswaPerKelas:', siswaPerKelas);

      if (jenjang && siswaPerKelas[jenjang]) {
        const kelasOptions = Object.keys(siswaPerKelas[jenjang]);
        console.log(`Available kelas for ${jenjang}:`, kelasOptions);
        
        kelasOptions.forEach(function(kls) {
          const siswaCount = siswaPerKelas[jenjang][kls].length;
          const option = document.createElement("option");
          option.value = kls;
          option.text = `${jenjang} ${kls} (${siswaCount} siswa)`;
          kelasSelect.add(option);
        });
        kelasSelect.disabled = false;
      }
    }

    function updateNamaSiswa() {
      const jenjang = document.getElementById("jenjang").value;
      const kelas = document.getElementById("kelasSiswa").value;
      const namaSelect = document.getElementById("namaSiswa");

      namaSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';

      console.log(`updateNamaSiswa called with jenjang: ${jenjang}, kelas: ${kelas}`);

      if (jenjang && kelas && siswaPerKelas[jenjang] && siswaPerKelas[jenjang][kelas]) {
        const daftarNama = siswaPerKelas[jenjang][kelas];
        console.log(`Students in ${jenjang} ${kelas}:`, daftarNama);
        
        daftarNama.forEach(function(nama) {
          const option = document.createElement("option");
          option.value = nama;
          option.text = nama;
          namaSelect.add(option);
        });
      }
    }

    const dataPelanggaran = {
      sikap: {
        "Mencoret-coret atau mengotori dinding, pintu, meja, kursi, pagar sekolah.": 10,
        "Membawa atau bermain kartu remi dan domino di Sekolah": 10,
        "Bermain bola di koridor dan di dalam kelas": 10,
        "Melindungi teman yang bersalah": 15,
        "Berpacaran di lingkungan sekolah": 20,
        "Berperilaku jorok atau asusila baik di dalam maupun di luar sekolah": 20,
        "Merayakan ulang tahun berlebihan": 20,
        "Membawa atau menyembunyikan petasan": 30,
        "Membuat surat izin palsu": 40,
        "Meloncat jendela dan pagar sekolah": 40,
        "Merusak sarana dan prasarana sekolah": 40,
        "Bertindak tidak sopan/melecehkan Kepala Sekolah, guru dan karyawan sekolah": 50,
        "Mengancam/mengintimidasi teman sekelas/teman sekolah": 75,
        "Mengancam/mengintimidasi Kepala Sekolah, guru dan karyawan": 100,
        "Membawa/merokok di lingkungan sekolah dan di luar sekolah saat masih mengenakan seragam sekolah": 100,
        "Menyalahgunakan media sosial yang merugikan pihak lain yang berhubungan dengan sekolah": 100,
        "Membuat dan menyebarkan berita bohong (hoax)": 100,
        "Berjudi dalam bentuk apapun disekolah": 150,
        "Membawa senjata tajam, senjata api dsb. di sekolah": 150,
        "Terlibat langsung maupun tidak langsung perkelahian/tawuran di sekolah, diluar sekolah atau antar sekolah": 150,
        "Mengikuti aliran/perkumpulan/geng terlarang/ Komunitas LGBT dan Radikalisme": 150,
        "Membawa, menggunakan atau mengedarkan miras, narkoba dan zat psikotropika lainnya": 250,
        "Membuat dan menyebarkan video, foto, konten yang berbau pronografi dan pornoaksi": 250,
        "Membuat atay menyebarkan video, foto, konten yang berbau bullying": 250,
        "Mencuri di sekolah dan diluar sekolah": 250,
        "Memalsukan stempel sekolah, edaran sekolah atau tanda tangan Kepala Sekolah, guru dan karyawan sekolah": 250,
        "Terbukti hamil atau menghamili": 250,
        "Terbukti menikah": 250
      },
      kedisiplinan: {
        "Datang terlambat": 10,
        "Tidak mengikuti dan melaksanakan piket kelas.": 10,
        "Tidak masuk sekolah tanpa keterangan.": 20,
        "Tidak mengikuti upacara": 20,
        "Tidak mengikuti kegiatan sekolah": 20,
        "Tidak hadir mengikuti kegiatan ekstrakurikuler yang diikutinya": 20
      },
      kerapian: {
        "Tidak berseragam sesuai dengan ketentuan.": 10,
        "Tidak memasukkan baju.": 10,
        "Melipat lengan baju, baju tidak dikancingkan.": 10,
        "Seragam yang dicoret-coret.": 10,
        "Celana atau rok bawah tidak dikelim.": 10,
        "Celana atau rok sobek": 10,
        "Tidak memakai kaos kaki.": 10,
        "Memakai kaos kaki tidak sesuai ketentuan ( senin-kamis putih, Jum'at hitam).": 10,
        "Tidak memakai ikat pinggang.": 10,
        "Memakai ikat pinggang tidak sesuai dengan ketentuan (hitam)": 10,
        "Atribut seragam tidak lengkap.": 10,
        "Tidak memakai sepatu hitam sesuai hari yang sudah ditetapkan": 10,
        "Peserta didik memakai sandal di lingkungan sekolah di luar jadwal kegiatan sholat.": 10,
        "Berambut panjang terurai.": 10,
        "Memakai perhiasan berlebihan selain cincin, kalung, dan  anting.": 10,
        "Memakai segala bentuk jenis gelang kecuali jam tangan.": 10,
        "Memakai anting, tindik, tato, kalung, gelang dan rantai di saku.": 20,
        "Alis dicukur, memakai make up berlebihan, memakai lipstik, dan memakai cat kuku.": 20,
        "Memakai baju ketat.": 20,
        "Memakai celana pensil / ketat.": 20
      }
    };

    const dataSiswa = {};
    const modal = document.getElementById("modalForm");
    const btnOpen = document.getElementById("btnOpenModal");
    const btnClose = document.querySelector(".close");
    const kategoriSelect = document.getElementById("kategoriSelect");
    const pelanggaranSelect = document.getElementById("pelanggaranSelect");

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
      loadStudentData();
    });

    btnOpen.onclick = () => {
      if (!isDataLoaded) {
        alert('Data siswa sedang dimuat. Silakan tunggu sebentar.');
        return;
      }
      modal.style.display = "block"; 
      document.getElementById("tanggal").valueAsDate = new Date(); 
    };
    
    btnClose.onclick = () => modal.style.display = "none";
    window.onclick = (e) => {
      if (e.target === modal) modal.style.display = "none";
    };

    kategoriSelect.addEventListener("change", () => {
      const kategori = kategoriSelect.value;
      pelanggaranSelect.innerHTML = '<option value="">-- Pilih Pelanggaran --</option>';
      if (dataPelanggaran[kategori]) {
        for (const jenis in dataPelanggaran[kategori]) {
          const option = document.createElement("option");
          option.value = jenis;
          option.textContent = jenis;
          pelanggaranSelect.appendChild(option);
        }
      }
    });

    function kategoriSkor(skor) {
      if (skor <= 35) return '<span class="badge ringan">Ringan</span>';
      if (skor <= 75) return '<span class="badge sedang">Sedang</span>';
      if (skor <= 249) return '<span class="badge berat">Berat</span>';
      return '<span class="badge sangat-berat">Sangat Berat</span>';
    }

    function tindakan(skor) {
      if (skor <= 35) return "Peringatan I";
      if (skor <= 55) return "Peringatan II";
      if (skor <= 75) return "Panggilan OT I";
      if (skor <= 95) return "Panggilan OT II";
      if (skor <= 150) return "Panggilan OT III";
      if (skor <= 249) return "Surat Pernyataan";
      return "Dikembalikan ke Orang Tua";
    }

function tambahPelanggaran() {
  const nama = document.getElementById("namaSiswa").value.trim();
  const jenjang = document.getElementById("jenjang").value.trim();
  const kelas = document.getElementById("kelasSiswa").value.trim();
  const tanggal = document.getElementById("tanggal").value;
  const kategori = kategoriSelect.value;
  const jenis = pelanggaranSelect.value;
  const skor = dataPelanggaran[kategori]?.[jenis] || 0;

  if (!nama || !kelas || !tanggal || !kategori || !jenis) {
    alert("Harap isi semua data termasuk tanggal.");
    return;
  }

  const keySiswa = `${nama.toLowerCase()}-${jenjang}${kelas}`;
  const kelasDisplay = `${jenjang} ${kelas}`;

if (!dataSiswa[keySiswa]) {
  dataSiswa[keySiswa] = {
    skor: skor,
    pelanggaran: [{ tanggal, jenis, skor }]
  };
} else {
  dataSiswa[keySiswa].skor += skor;
  dataSiswa[keySiswa].pelanggaran.push({ tanggal, jenis, skor });
}

const daftarPelanggaran = dataSiswa[keySiswa].pelanggaran
  .map(p => p.jenis)
  .join("<br>");

  const tbody = document.getElementById("tabelHasil");

  let existingRow = Array.from(tbody.rows).find(
    row => row.cells[1].textContent.toLowerCase() === nama.toLowerCase() &&
           row.cells[2].textContent.toLowerCase() === kelasDisplay.toLowerCase()
  );

if (existingRow) {
  existingRow.cells[4].innerHTML = daftarPelanggaran;
  existingRow.cells[5].textContent = dataSiswa[keySiswa].skor;
  existingRow.cells[6].innerHTML = kategoriSkor(dataSiswa[keySiswa].skor);
  existingRow.cells[7].textContent = tindakan(dataSiswa[keySiswa].skor);
} else {
  const no = tbody.rows.length + 1;
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${no}</td>
    <td>${nama}</td>
    <td>${kelasDisplay}</td>
    <td>${tanggal}</td>
    <td>${daftarPelanggaran}</td>
    <td>${dataSiswa[keySiswa].skor}</td>
    <td>${kategoriSkor(dataSiswa[keySiswa].skor)}</td>
    <td>${tindakan(dataSiswa[keySiswa].skor)}</td>
  `;
  tbody.appendChild(row);
}

  document.getElementById("emptyState").style.display = "none";

  // Reset form
  document.getElementById("jenjang").value = "";
  document.getElementById("kelasSiswa").innerHTML = '<option value="">-- Pilih Kelas --</option>';
  document.getElementById("kelasSiswa").disabled = true;
  document.getElementById("namaSiswa").innerHTML = '<option value="">-- Pilih Nama --</option>';
  document.getElementById("tanggal").value = "";
  kategoriSelect.value = "";
  pelanggaranSelect.innerHTML = '<option value="">-- Pilih Pelanggaran --</option>';
  modal.style.display = "none";
}

  document.getElementById("btnTambah").addEventListener("click", tambahPelanggaran);
  document.getElementById("downloadPDF").addEventListener("click", () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  const headers = [["No", "Nama", "Kelas", "Tanggal", "Pelanggaran", "Skor", "Kategori", "Tindakan"]];
  const body = [];

  const rows = document.querySelectorAll("#tabelHasil tr");
  rows.forEach((row) => {
    const rowData = Array.from(row.cells).map(cell => cell.textContent.trim());
    body.push(rowData);
  });

  const today = new Date();
const tanggalCetak = `${today.getDate().toString().padStart(2, '0')}-${(today.getMonth()+1).toString().padStart(2, '0')}-${today.getFullYear()}`;

const img = new Image();
img.src = "image.png"; // Logo sekolah

img.onload = () => {
  const pdf = new jsPDF();

  // Header
  pdf.addImage(img, "PNG", 15, 10, 25, 25);
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("REKAPITULASI PELANGGARAN SISWA", 105, 15, { align: "center" });

  pdf.setFontSize(12);
  pdf.text("SMAN 1 KARANGAN", 105, 22, { align: "center" });

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(10);
  pdf.text("Jl. Raya Karangan No. 45, Trenggalek, Jawa Timur", 105, 28, { align: "center" });
  pdf.text("Tel: (0355) 791540, E-mail: sman1karangan@email.sch.id", 105, 33, { align: "center" });

  pdf.setDrawColor(0);
  pdf.setLineWidth(0.5);
  pdf.line(15, 37, 195, 37);

  // Tanggal cetak
  pdf.setFontSize(10);
  pdf.text(`Tanggal Cetak : ${tanggalCetak}`, 15, 43);

  // Tabel data pelanggaran
  pdf.autoTable({
    head: headers,
    body: body,
    startY: 48,
    styles: { fontSize: 9, cellPadding: 3 },
    headStyles: { fillColor: [41, 128, 185] },
    theme: 'grid'
  });

// Ukuran halaman
const pageHeight = pdf.internal.pageSize.getHeight();
const ttdY = pageHeight - 65;

// Titik tengah kolom tanda tangan
const centerKiri = 55;   // 15 + (80 / 2)
const centerKanan = 170; // 140 + (60 / 2)

pdf.setFontSize(10);

// Kepala Sekolah - Rata Tengah
pdf.text(`Karangan, ${tanggalCetak}`, centerKiri, ttdY, { align: 'center' });
pdf.text("Kepala SMAN 1 Karangan,", centerKiri, ttdY + 6, { align: 'center' });
pdf.text("AGUS JOKO SANTOSO,S.Pd", centerKiri, ttdY + 26, { align: 'center' });
pdf.text("NIP. 19670921 199003 1 005", centerKiri, ttdY + 31, { align: 'center' });

// Tim Tata Tertib - Rata Tengah
pdf.text("Mengetahui,", centerKanan, ttdY, { align: 'center' });
pdf.text("Tim Tata Tertib,", centerKanan, ttdY + 6, { align: 'center' });
pdf.text("MAHFUD, S.Pd.", centerKanan, ttdY + 26, { align: 'center' });
pdf.text("NIP. 196907201995121002", centerKanan, ttdY + 31, { align: 'center' });


  // Simpan PDF
  pdf.save("rekap_pelanggaran.pdf");
 };

});

  let isLoggedIn = false;

    document.getElementById("btnOpenModal").onclick = () => {
      if (!isDataLoaded) {
        alert('Data siswa sedang dimuat. Silakan tunggu sebentar.');
        return;
      }
      
      modal.style.display = "block";

      if (isLoggedIn) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("formSection").style.display = "block";
        document.getElementById("tanggal").valueAsDate = new Date();
      } else {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("formSection").style.display = "none";
      }
    };

    document.getElementById("loginBtn").onclick = () => {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (username === "admin" && password === "12345") {
        isLoggedIn = true;

        document.getElementById("username").value = "";
        document.getElementById("password").value = "";

        document.getElementById("loginSection").style.display = "none";
        document.getElementById("formSection").style.display = "block";
        document.getElementById("tanggal").valueAsDate = new Date();
      } else {
        alert("Login gagal! Username atau password salah.");
      }
    };

    document.querySelector(".close").onclick = () => {
      modal.style.display = "none";
      if (!isLoggedIn) {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("formSection").style.display = "none";
      }
    };

  </script>
  </div>
</body>
</html>