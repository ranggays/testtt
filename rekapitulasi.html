<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rekapitulasi</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }

    .header-wrapper {
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo img {
      width: 40px;
      height: 40px;
    }

    .logo span {
      font-weight: 600;
      font-size: 1.1rem;
      color: #2c3e50;
    }

    .nav-links {
      display: flex;
      gap: 2rem;
    }

    .nav-links a {
      text-decoration: none;
      color: #555;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .nav-links a:hover,
    .nav-links a.active {
      background-color: #3498db;
      color: white;
    }

    .main-content {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .header h2 {
      color: #2c3e50;
      font-size: 1.5rem;
    }

    #btnOpenModal {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #btnOpenModal:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
    }

    #rekapArea {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    table th,
    table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }

    table tr:hover {
      background-color: #f8f9fa;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge.ringan {
      background-color: #d4edda;
      color: #155724;
    }

    .badge.sedang {
      background-color: #fff3cd;
      color: #856404;
    }

    .badge.berat {
      background-color: #f8d7da;
      color: #721c24;
    }

    .badge.sangat-berat {
      background-color: #f5c6cb;
      color: #721c24;
    }

    #downloadPDF {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #downloadPDF:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    #emptyState {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    #emptyState img {
      opacity: 0.7;
      margin-bottom: 1rem;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .close {
      color: #999;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #333;
    }

    .modal-content label {
      display: block;
      margin: 1rem 0 0.5rem 0;
      font-weight: 600;
      color: #2c3e50;
    }

    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .modal-content input:focus,
    .modal-content select:focus {
      outline: none;
      border-color: #3498db;
    }

    #loginBtn,
    #btnTambah {
      background: linear-gradient(135deg, #27ae60, #219a52);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 1rem;
      width: 100%;
      transition: all 0.3s ease;
    }

    #loginBtn:hover,
    #btnTambah:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 1rem;
      color: #666;
    }

    .loading.show {
      display: block;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 0.8rem;
      border-radius: 8px;
      margin: 1rem 0;
      display: none;
    }

    .error.show {
      display: block;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      padding: 0.8rem;
      border-radius: 8px;
      margin: 1rem 0;
      display: none;
    }

    .success.show {
      display: block;
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 1rem;
      }

      .nav-links {
        flex-wrap: wrap;
        justify-content: center;
      }

      .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      table {
        font-size: 0.9rem;
      }

      .modal-content {
        margin: 2% auto;
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <div class="header-wrapper">
    <header class="navbar">
      <div class="logo">
        <img src="https://via.placeholder.com/40x40/3498db/ffffff?text=S" alt="Logo" />
        <span>SMAN 1 KARANGAN</span>
      </div>
      <nav class="nav-links">
        <a href="home.html">Home</a>
        <a href="list-pelanggaran.html">List Pelanggaran</a>
        <a href="rekapitulasi.html" class="active">Rekap Pelanggaran</a>
        <a href="info.html">Info ▾</a>
        <a href="contact.html">Contact</a>
      </nav>
    </header>
  </div>
        
  <div class="main-content">
    <div class="header">
      <h2>REKAPITULASI PELANGGARAN TATA TERTIB SISWA</h2>
      <button id="btnOpenModal">+ Add Data</button>
    </div>

    <div class="loading" id="loadingIndicator">
      <i class="fas fa-spinner fa-spin"></i> Memuat data...
    </div>

    <div class="error" id="errorMessage"></div>
    <div class="success" id="successMessage"></div>

    <div id="rekapArea">
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Kelas</th>
            <th>Tanggal</th>
            <th>Pelanggaran</th>
            <th>Skor</th>
            <th>Kategori</th>
            <th>Tindakan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tabelHasil"></tbody>
      </table>
    </div>

    <button id="downloadPDF" style="margin-top: 16px;">Download PDF</button>

    <div id="emptyState">
      <img src="https://cdn-icons-png.flaticon.com/512/4076/4076508.png" width="150" alt="Empty illustration">
      <p>Belum ada data pelanggaran.<br>Silakan klik tombol <b>+ Add Data</b> untuk menambahkan.</p>
    </div>
  </div>

  <div id="modalForm" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>

      <!-- LOGIN ADMIN -->
      <div id="loginSection">
        <h3>Login Admin</h3>
        <label for="username">Username Admin:</label>
        <input type="text" id="username" placeholder="Masukkan username">

        <label for="password">Password:</label>
        <input type="password" id="password" placeholder="Masukkan password">

        <button id="loginBtn">Login</button>
      </div>

      <!-- FORM TAMBAH PELANGGARAN -->
      <div id="formSection" style="display:none;">
        <h3>Tambah Pelanggaran</h3>
        
        <!-- Jenjang (X, XI, XII) -->
        <label for="jenjang">Jenjang:</label>
        <select id="jenjang" onchange="updateKelas()">
          <option value="">-- Pilih Jenjang --</option>
          <option value="X">X</option>
          <option value="XI">XI</option>
          <option value="XII">XII</option>
        </select>
          
        <!-- Kelas (A–I) -->
        <label for="kelasSiswa">Kelas:</label>
        <select id="kelasSiswa" onchange="updateNamaSiswa()" disabled>
          <option value="">-- Pilih Kelas --</option>
        </select>

        <!-- Nama Siswa (Dropdown) -->
        <label for="namaSiswa">Nama Siswa:</label>
        <select id="namaSiswa" required>
          <option value="">-- Pilih Nama --</option>
        </select>

        <!-- Tanggal -->
        <label for="tanggal">Tanggal:</label>
        <input type="date" id="tanggal">

        <label for="kategoriSelect">Kategori Pelanggaran:</label>
        <select id="kategoriSelect">
          <option value="">-- Pilih Kategori --</option>
          <option value="sikap">Sikap Perilaku</option>
          <option value="kedisiplinan">Kedisiplinan</option>
          <option value="kerapian">Kerapian</option>
        </select>

        <label for="pelanggaranSelect">Jenis Pelanggaran:</label>
        <select id="pelanggaranSelect">
          <option value="">-- Pilih Pelanggaran --</option>
        </select>

        <button id="btnTambah">Tambah Pelanggaran</button>
      </div>
    </div>
  </div>

  <script>
    // SheetDB Configuration - REPLACE WITH YOUR SHEETDB API URL
    const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/isi nde kene';

    // Student data per class
    const siswaPerKelas = {
      X: {
        "A": ["ABELIA FIRNANDA PUTRI","AFRIZAL DIMAS ADITYA PUTRA","ALVITA ZAIDA RIATMANTO","ANDHIKA NADHIT WIDYADANA","ANEZKA NADINDRA ISNANTO","ARDIANTI TYAS MARTA","AURA MARZA GIAN PUTRI","AZRIEL RAFI PUTRA DEWANGGA","CALLYSTA ELFIDA FAIZIN","DELLA FIFTINE ARWIDYA RAHAYU","DEVAUZI WAHYU PRATAMA","DIFFANIA NASYWA VIOLLIN","ELMA AUSY HADIYAN PRASYANTI","FAHRI EKA PRASETYO","FARIDA NUR KHASANAH","GALIH DIVO DWIDEZCO","GRENANZA VILOVELLIAN MARTAFENA","JANELIA ALTA MINANTI","KINARA DWI PURWENI","LEO PUTRA RAMADHAN","MAULIDA NUR AINI FATIMATUSH ZAHRO","MUHAMMAD DAFFA ALFIN MANSUR","NAFISA HUWAIDA KARIMA","NATASYA NIYA SAFINA DEFTANENSI","PAMELA PRIANKA SISWOYO","PRADIPTA MULYA HARIPANCARA","QUEENZHA AUREL AUFANDINA","REKSA BINTANG KUMARA","RENZA ALYA NURUL NGAIN","ROMADLONI SAPUTRI","SATRIA GESANG MANGGALI","SEPTI AULIA RAHMADHANI","SYAINA FIRYAL KHANZA BALQIS","VICKY ALDIANSYAH","VIERRA DWI MAHARANI","ZAFIRA PUTRI SABRINA"],
        "B": ["AGAM MAYUN SAMIRANA","AILEN AGUSTINE WIBOWO","ALYA AZZAHRA PUTRI","ANDIKA PUTRA PRATAMA","ANINDYA NAURA YUDISTIRA","ARIMBI LENTERA GEMALARAS","AURUM SALSABILA","AZRIL OKTAVIAN MALIK","CALYA IVANA GIYANITA","DESTA ZAIMU ADDAH","DIAN ROSIANDY","DINDA AYU PRATIWI","ELYSIA ELITA WIDYA WARDANY","FAIRUZ ZABADY","FERYUNDHA ZAINABIL AFAANIIN","GALIH WAHYU FRANTINO","INTAN ZAHRASITA AIRANI","JENNITA SIFA FIRDAUS","KHAYLILA ISNANIA PUTRI","MAULIDINA ASTI CHOIRUNNISA","MEILANO AVA MAHENDRA","MUHAMMAD DUTA FERDIANSYAH","NADINE VIVIA RENATA","NENCY CAHYA DEA LOVETA","PINASTI KEN LANDHUNGSIH","PRANAJA HADRA ADINATA","RAHMA OKKI DIAH RANGGA","RENDYKA MEYVANO PUTRA GIONTIKA","REVA LUTFIANA DEWI","SADINA MAHATMA NIRWASITA PRIYENDA","SHANDY AYU PUSPITASARI","SHELVIN RAYHAN WIMANDHA PUTRA","TAHTA ARIFAH NASTITI","VINA ABIERLIYA MARSANDA","VRADIKA CAHYA SAPUTRA","ZAHWA AQILA RAMADANI"]
      },
      XI: {
        "A": ["ADHITYA RAIHAN SAPUTRA","ADYA DWI ARDINI","AGESTI FIRSTA AZZAHRA","ALDO DWI PUTRA","ALENTA NARA LIVA","AMELYA MARSYA FEBRIANTI","ASYIFA RAYHAN GUMILANG","BAGAS PRADIPA UNTARA","CICHA DISYANA PERMATASARI","DAVINO EKA PRATAMA","DHINDA PUTRI DONIKA","EKA SULISTRI RAHMADANI","FARID ADITYA PRATAMA","FERRY DWI KENCANA PUTRA","FRADIS TENTY REVILA","GALIH GINANJAR","GALUH KHOIRUNNISA","GHINA ZULFA ADILA","HANIN MADICHAH ADHA","ISMA IKA PERTIWI","JEVINCO DINDRA OGUSTA","KEYLA KARUNIA MAULIDYA","LAURA MARZA TWOENTA","MAYA DWI REGINA SOLIKHA","MUHAMMAD DONNY ALFIANSYAH","NADIANG PUTRI KINANTI","NINDITYA ALENCIA FITRI","NOVAL RAHMA YUDISTIRA","OLEGA SARAS ADELIA PRAMESTI","PUTRI MARSELA TRIA NINGSIH","RIFALDI AFDHIL RAHMAN","SELVIA SRI RAHAYU","SYAFA KAYLA NATANIA","TIARA CANDRA ASHARI","YANUAR AHMAD BINTANG MAULANA","ZASKYA NAILATUL MAROM"]
      },
      XII: {
        "A": ["AFANDI PRATAMA","AHMAD DHUAN AGATHA","AL IKHSANDRIA ALIF RAMADHANI","ANISA CAHYA PUSPITA","A'QLI WAHYULISTYAWAN PUTRA","BINTANG ANUGERAH HADI","BUNGA KRISDA ARGASARI","CAHYO DWI FIRMANSYAH","DEVIANA JIHAN NATARA","ERLIA NANDITA NOVIANA","FABHI RIZA MULYA WANDANA PUTRA","FANDY ARYA WIDYADHANA","GARGA CIPTA HANDARU","JIMMY NANDA WIBAWA","JOAN GAYNELL FEBRIAN","KHALILA ANNASTASYA MEIROSSA PUTRI","LEOGA MARGASENA FATTAH","MARLA NOVA PRATIWI","MUHAMMAD AGHA NAUFAL FEBRYANNESAR","MUHAMMAD DANU PRAKOSO","MUHAMMAD EVAN SYAPUTRA","MUHAMMAD FARHAN SAIFUSSURUR","MUHAMMAD GHIFARI DHAVIANSYAH","NABILLA SUTRISNO","NAUFAL ZAKI ALKHALIFI","NAYSELLA LINTANG PRAMESWARI","RADO MARCHEL ANGGARA","RANGGA AJI PERDANA WIDIAMANGGALA","RENANTA PUTRI WIJAYA","RENDY AGUSTYAN","RIFA NASRUL HIDAYATULLOH","SALMA SEPTYANA KUSUMA AYUNINGTYAS","TASYA MINHATAL AINI","TEGUH PRIYO UTOMO","VANNISA APRILIA WIDIYANTIKA"]
      }
    };

    // Violation data
    const dataPelanggaran = {
      sikap: {
        "Mencoret-coret atau mengotori dinding, pintu, meja, kursi, pagar sekolah.": 10,
        "Membawa atau bermain kartu remi dan domino di Sekolah": 10,
        "Bermain bola di koridor dan di dalam kelas": 10,
        "Melindungi teman yang bersalah": 15,
        "Berpacaran di lingkungan sekolah": 20,
        "Berperilaku jorok atau asusila baik di dalam maupun di luar sekolah": 20,
        "Merayakan ulang tahun berlebihan": 20,
        "Membawa atau menyembunyikan petasan": 30,
        "Membuat surat izin palsu": 40,
        "Meloncat jendela dan pagar sekolah": 40,
        "Merusak sarana dan prasarana sekolah": 40,
        "Bertindak tidak sopan/melecehkan Kepala Sekolah, guru dan karyawan sekolah": 50,
        "Mengancam/mengintimidasi teman sekelas/teman sekolah": 75,
        "Mengancam/mengintimidasi Kepala Sekolah, guru dan karyawan": 100,
        "Membawa/merokok di lingkungan sekolah dan di luar sekolah saat masih mengenakan seragam sekolah": 100,
        "Menyalahgunakan media sosial yang merugikan pihak lain yang berhubungan dengan sekolah": 100,
        "Membuat dan menyebarkan berita bohong (hoax)": 100,
        "Berjudi dalam bentuk apapun disekolah": 150,
        "Membawa senjata tajam, senjata api dsb. di sekolah": 150,
        "Terlibat langsung maupun tidak langsung perkelahian/tawuran di sekolah, diluar sekolah atau antar sekolah": 150,
        "Mengikuti aliran/perkumpulan/geng terlarang/ Komunitas LGBT dan Radikalisme": 150,
        "Membawa, menggunakan atau mengedarkan miras, narkoba dan zat psikotropika lainnya": 250,
        "Membuat dan menyebarkan video, foto, konten yang berbau pronografi dan pornoaksi": 250,
        "Membuat atay menyebarkan video, foto, konten yang berbau bullying": 250,
        "Mencuri di sekolah dan diluar sekolah": 250,
        "Memalsukan stempel sekolah, edaran sekolah atau tanda tangan Kepala Sekolah, guru dan karyawan sekolah": 250,
        "Terbukti hamil atau menghamili": 250,
        "Terbukti menikah": 250
      },
      kedisiplinan: {
        "Datang terlambat": 10,
        "Tidak mengikuti dan melaksanakan piket kelas.": 10,
        "Tidak masuk sekolah tanpa keterangan.": 20,
        "Tidak mengikuti upacara": 20,
        "Tidak mengikuti kegiatan sekolah": 20,
        "Tidak hadir mengikuti kegiatan ekstrakurikuler yang diikutinya": 20
      },
      kerapian: {
        "Tidak berseragam sesuai dengan ketentuan.": 10,
        "Tidak memasukkan baju.": 10,
        "Melipat lengan baju, baju tidak dikancingkan.": 10,
        "Seragam yang dicoret-coret.": 10,
        "Celana atau rok bawah tidak dikelim.": 10,
        "Celana atau rok sobek": 10,
        "Tidak memakai kaos kaki.": 10,
        "Memakai kaos kaki tidak sesuai ketentuan ( senin-kamis putih, Jum'at hitam).": 10,
        "Tidak memakai ikat pinggang.": 10,
        "Memakai ikat pinggang tidak sesuai dengan ketentuan (hitam)": 10,
        "Atribut seragam tidak lengkap.": 10,
        "Tidak memakai sepatu hitam sesuai hari yang sudah ditetapkan": 10,
        "Peserta didik memakai sandal di lingkungan sekolah di luar jadwal kegiatan sholat.": 10,
        "Berambut panjang terurai.": 10,
        "Memakai perhiasan berlebihan selain cincin, kalung, dan  anting.": 10,
        "Memakai segala bentuk jenis gelang kecuali jam tangan.": 10,
        "Memakai anting, tindik, tato, kalung, gelang dan rantai di saku.": 20,
        "Alis dicukur, memakai make up berlebihan, memakai lipstik, dan memakai cat kuku.": 20,
        "Memakai baju ketat.": 20,
        "Memakai celana pensil / ketat.": 20
      }
    };

    // Global variables
    let isLoggedIn = false;
    let violationData = [];

    // DOM Elements
    const modal = document.getElementById("modalForm");
    const btnOpen = document.getElementById("btnOpenModal");
    const btnClose = document.querySelector(".close");
    const kategoriSelect = document.getElementById("kategoriSelect");
    const pelanggaranSelect = document.getElementById("pelanggaranSelect");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const errorMessage = document.getElementById("errorMessage");
    const successMessage = document.getElementById("successMessage");

    // Utility functions
    function showLoading() {
      loadingIndicator.classList.add('show');
    }

    function hideLoading() {
      loadingIndicator.classList.remove('show');
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => errorMessage.classList.remove('show'), 5000);
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.add('show');
      setTimeout(() => successMessage.classList.remove('show'), 3000);
    }

    function kategoriSkor(skor) {
      if (skor <= 35) return '<span class="badge ringan">Ringan</span>';
      if (skor <= 75) return '<span class="badge sedang">Sedang</span>';
      if (skor <= 249) return '<span class="badge berat">Berat</span>';
      return '<span class="badge sangat-berat">Sangat Berat</span>';
    }

    function tindakan(skor) {
      if (skor <= 35) return "Peringatan I";
      if (skor <= 55) return "Peringatan II";
      if (skor <= 75) return "Panggilan OT I";
      if (skor <= 95) return "Panggilan OT II";
      if (skor <= 150) return "Panggilan OT III";
      if (skor <= 249) return "Surat Pernyataan";
      return "Dikembalikan ke Orang Tua";
    }

    // Student selection functions
    function updateKelas() {
      const jenjang = document.getElementById("jenjang").value;
      const kelasSelect = document.getElementById("kelasSiswa");
      const namaSelect = document.getElementById("namaSiswa");

      kelasSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
      namaSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';
      kelasSelect.disabled = true;

      if (siswaPerKelas[jenjang]) {
        Object.keys(siswaPerKelas[jenjang]).forEach(function(kls) {
          const option = document.createElement("option");
          option.value = kls;
          option.text = jenjang + " " + kls;
          kelasSelect.add(option);
        });
        kelasSelect.disabled = false;
      }
    }

    function updateNamaSiswa() {
      const jenjang = document.getElementById("jenjang").value;
      const kelas = document.getElementById("kelasSiswa").value;
      const namaSelect = document.getElementById("namaSiswa");

      namaSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';

      if (siswaPerKelas[jenjang] && siswaPerKelas[jenjang][kelas]) {
        siswaPerKelas[jenjang][kelas].forEach(function(nama) {
          const option = document.createElement("option");
          option.value = nama;
          option.text = nama;
          namaSelect.add(option);
        });
      }
    }

    // SheetDB API functions
    async function loadDataFromSheet() {
      try {
        showLoading();
        const response = await fetch(SHEETDB_API_URL);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        violationData = data || [];
        renderTable();
        hideLoading();
      } catch (error) {
        console.error('Error loading data:', error);
        showError('Gagal memuat data dari database. Periksa koneksi internet atau URL SheetDB.');
        hideLoading();
      }
    }

    async function saveToSheet(newViolation) {
      try {
        showLoading();
        const response = await fetch(SHEETDB_API_URL, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            data: [newViolation]
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        showSuccess('Data berhasil disimpan!');
        hideLoading();
        return result;
      } catch (error) {
        console.error('Error saving data:', error);
        showError('Gagal menyimpan data. Periksa koneksi internet atau URL SheetDB.');
        hideLoading();
        throw error;
      }
    }

    async function updateStudentInSheet(studentKey, updatedData) {
      try {
        showLoading();
        
        // First, try to update existing record
        const response = await fetch(`${SHEETDB_API_URL}/nama/${updatedData.nama}/kelas/${updatedData.kelas}`, {
          method: 'PATCH',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            data: updatedData
          })
        });

        if (!response.ok) {
          // If update fails, try to create new record
          return await saveToSheet(updatedData);
        }

        const result = await response.json();
        showSuccess('Data berhasil diperbarui!');
        hideLoading();
        return result;
      } catch (error) {
        console.error('Error updating data:', error);
        showError('Gagal memperbarui data.');
        hideLoading();
        throw error;
      }
    }

    async function deleteFromSheet(id) {
      try {
        showLoading();
        const response = await fetch(`${SHEETDB_API_URL}/id/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        showSuccess('Data berhasil dihapus!');
        hideLoading();
        return true;
      } catch (error) {
        console.error('Error deleting data:', error);
        showError('Gagal menghapus data.');
        hideLoading();
        return false;
      }
    }

    // Render table from violation data
    function renderTable() {
      const tbody = document.getElementById("tabelHasil");
      const emptyState = document.getElementById("emptyState");
      
      tbody.innerHTML = "";

      if (violationData.length === 0) {
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";

      // Group violations by student
      const groupedData = {};
      violationData.forEach(violation => {
        const key = `${violation.nama}-${violation.kelas}`;
        if (!groupedData[key]) {
          groupedData[key] = {
            nama: violation.nama,
            kelas: violation.kelas,
            violations: [],
            totalSkor: 0
          };
        }
        groupedData[key].violations.push(violation);
        groupedData[key].totalSkor += parseInt(violation.skor) || 0;
      });

      // Render grouped data
      let no = 1;
      Object.values(groupedData).forEach(student => {
        const row = document.createElement("tr");
        
        const latestViolation = student.violations[student.violations.length - 1];
        const violationList = student.violations
          .map(v => `${v.tanggal}: ${v.jenis_pelanggaran}`)
          .join("<br>");

        row.innerHTML = `
          <td>${no++}</td>
          <td>${student.nama}</td>
          <td>${student.kelas}</td>
          <td>${latestViolation.tanggal}</td>
          <td>${violationList}</td>
          <td>${student.totalSkor}</td>
          <td>${kategoriSkor(student.totalSkor)}</td>
          <td>${tindakan(student.totalSkor)}</td>
          <td>
            <button onclick="deleteStudent('${student.nama}', '${student.kelas}')" 
                    style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Delete student function
    async function deleteStudent(nama, kelas) {
      if (!confirm(`Hapus semua data pelanggaran untuk ${nama} (${kelas})?`)) {
        return;
      }

      try {
        // Find and delete all violations for this student
        const studentViolations = violationData.filter(v => v.nama === nama && v.kelas === kelas);
        
        for (const violation of studentViolations) {
          if (violation.id) {
            await deleteFromSheet(violation.id);
          }
        }

        // Remove from local data
        violationData = violationData.filter(v => !(v.nama === nama && v.kelas === kelas));
        renderTable();
      } catch (error) {
        console.error('Error deleting student:', error);
      }
    }

    // Modal functions
    btnOpen.onclick = () => {
      modal.style.display = "block";

      if (isLoggedIn) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("formSection").style.display = "block";
        document.getElementById("tanggal").valueAsDate = new Date();
      } else {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("formSection").style.display = "none";
      }
    };

    btnClose.onclick = () => modal.style.display = "none";
    
    window.onclick = (e) => {
      if (e.target === modal) modal.style.display = "none";
    };

    // Category selection
    kategoriSelect.addEventListener("change", () => {
      const kategori = kategoriSelect.value;
      pelanggaranSelect.innerHTML = '<option value="">-- Pilih Pelanggaran --</option>';
      if (dataPelanggaran[kategori]) {
        for (const jenis in dataPelanggaran[kategori]) {
          const option = document.createElement("option");
          option.value = jenis;
          option.textContent = jenis;
          pelanggaranSelect.appendChild(option);
        }
      }
    });

    // Add violation function
    async function tambahPelanggaran() {
      const jenjang = document.getElementById("jenjang").value.trim();
      const nama = document.getElementById("namaSiswa").value.trim();
      const kelas = document.getElementById("kelasSiswa").value.trim();
      const tanggal = document.getElementById("tanggal").value;
      const kategori = kategoriSelect.value;
      const jenis = pelanggaranSelect.value;
      const skor = dataPelanggaran[kategori]?.[jenis] || 0;

      if (!nama || !kelas || !tanggal || !kategori || !jenis) {
        alert("Harap isi semua data termasuk tanggal.");
        return;
      }

      const newViolation = {
        id: Date.now().toString(), // Simple ID generation
        nama: nama,
        kelas: `${jenjang} ${kelas}`,
        tanggal: tanggal,
        kategori: kategori,
        jenis_pelanggaran: jenis,
        skor: skor,
        created_at: new Date().toISOString()
      };

      try {
        await saveToSheet(newViolation);
        
        // Add to local data
        violationData.push(newViolation);
        renderTable();

        // Reset form
        document.getElementById("jenjang").value = "";
        document.getElementById("namaSiswa").value = "";
        document.getElementById("kelasSiswa").value = "";
        document.getElementById("tanggal").value = "";
        kategoriSelect.value = "";
        pelanggaranSelect.innerHTML = '<option value="">-- Pilih Pelanggaran --</option>';
        modal.style.display = "none";

      } catch (error) {
        console.error('Error adding violation:', error);
      }
    }

    // Login function
    document.getElementById("loginBtn").onclick = () => {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (username === "admin" && password === "12345") {
        isLoggedIn = true;

        document.getElementById("username").value = "";
        document.getElementById("password").value = "";

        document.getElementById("loginSection").style.display = "none";
        document.getElementById("formSection").style.display = "block";
        document.getElementById("tanggal").valueAsDate = new Date();
      } else {
        alert("Login gagal! Username atau password salah.");
      }
    };

    // Event listeners
    document.getElementById("btnTambah").addEventListener("click", tambahPelanggaran);

    // PDF Download function
    document.getElementById("downloadPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const headers = [["No", "Nama", "Kelas", "Tanggal", "Pelanggaran", "Skor", "Kategori", "Tindakan"]];
      const body = [];

      const rows = document.querySelectorAll("#tabelHasil tr");
      rows.forEach((row) => {
        const rowData = Array.from(row.cells).slice(0, 8).map(cell => cell.textContent.trim());
        body.push(rowData);
      });

      const today = new Date();
      const tanggalCetak = `${today.getDate().toString().padStart(2, '0')}-${(today.getMonth()+1).toString().padStart(2, '0')}-${today.getFullYear()}`;

      // Create PDF content
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(14);
      pdf.text("REKAPITULASI PELANGGARAN SISWA", 105, 20, { align: "center" });

      pdf.setFontSize(12);
      pdf.text("SMAN 1 KARANGAN", 105, 27, { align: "center" });

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(10);
      pdf.text("Jl. Raya Karangan No. 45, Trenggalek, Jawa Timur", 105, 33, { align: "center" });
      pdf.text("Tel: (0355) 791540, E-mail: sman1karangan@email.sch.id", 105, 38, { align: "center" });

      pdf.setDrawColor(0);
      pdf.setLineWidth(0.5);
      pdf.line(15, 42, 195, 42);

      pdf.setFontSize(10);
      pdf.text(`Tanggal Cetak : ${tanggalCetak}`, 15, 48);

      pdf.autoTable({
        head: headers,
        body: body,
        startY: 53,
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [41, 128, 185] },
        theme: 'grid',
        columnStyles: {
          4: { cellWidth: 40 } // Wider column for violations
        }
      });

      const pageHeight = pdf.internal.pageSize.getHeight();
      const ttdY = pageHeight - 65;

      const centerKiri = 55;
      const centerKanan = 170;

      pdf.setFontSize(10);

      pdf.text(`Karangan, ${tanggalCetak}`, centerKiri, ttdY, { align: 'center' });
      pdf.text("Kepala SMAN 1 Karangan,", centerKiri, ttdY + 6, { align: 'center' });
      pdf.text("AGUS JOKO SANTOSO,S.Pd", centerKiri, ttdY + 26, { align: 'center' });
      pdf.text("NIP. 19670921 199003 1 005", centerKiri, ttdY + 31, { align: 'center' });

      pdf.text("Mengetahui,", centerKanan, ttdY, { align: 'center' });
      pdf.text("Tim Tata Tertib,", centerKanan, ttdY + 6, { align: 'center' });
      pdf.text("MAHFUD, S.Pd.", centerKanan, ttdY + 26, { align: 'center' });
      pdf.text("NIP. 196907201995121002", centerKanan, ttdY + 31, { align: 'center' });

      pdf.save("rekap_pelanggaran.pdf");
    });

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      loadDataFromSheet();
    });

    // Make functions globally available
    window.updateKelas = updateKelas;
    window.updateNamaSiswa = updateNamaSiswa;
    window.deleteStudent = deleteStudent;
  </script>
</body>
</html>